# SPEC-011-D: Canvas BDD Test Plan

| Field | Value |
|-------|-------|
| **Spec ID** | SPEC-011-D |
| **ADR Reference** | [ADR-011: Canvas Integration and Testing Strategy](../ADR-011-Canvas-Integration-Testing.md) |
| **Date** | 2026-02-28 |
| **Status** | Active |

---

## Overview

This specification defines the BDD test plan for canvas E2E tests using playwright-bdd (v8.4.2). It covers the feature file inventory, step definition patterns, CI integration, dual-project Playwright configuration, and test data seeding strategy.

---

## Feature File Inventory

Twelve Gherkin feature files covering all canvas interaction paths:

| # | Feature File | Scope | Scenarios (est.) |
|---|-------------|-------|-------------------|
| 1 | `canvas-entity-add.feature` | Add entities to canvas via EntityDialog | 3 |
| 2 | `canvas-entity-delete.feature` | Delete nodes and their connected edges | 2 |
| 3 | `canvas-relationship-create.feature` | Connect nodes, RelationshipDialog flow | 3 |
| 4 | `canvas-save-load.feature` | Persist and restore canvas state | 2 |
| 5 | `canvas-keyboard.feature` | Keyboard navigation and shortcuts | 4 |
| 6 | `canvas-zoom-pan.feature` | Zoom in/out, fit view, pan | 3 |
| 7 | `canvas-browse-mode.feature` | Browse mode read-only interactions | 3 |
| 8 | `canvas-entity-detail.feature` | EntityDetailPanel display and close | 2 |
| 9 | `canvas-node-type-bug.feature` | Verify entityType used (not 'simpleEntity') | 2 |
| 10 | `canvas-sequence-diagram.feature` | Sequence model renders SequenceDiagram | 3 |
| 11 | `canvas-uml-full-view.feature` | UML model renders FullViewCanvas with UML types | 3 |
| 12 | `canvas-archimate-full-view.feature` | ArchiMate model renders FullViewCanvas with ArchiMate types | 3 |

**Total estimated scenarios: ~33**

---

## Step Definition Patterns

Step definitions are written in TypeScript and follow playwright-bdd conventions.

### Given Steps

| Pattern | Purpose |
|---------|---------|
| `Given I have a {string} model with {int} entities` | Seed model via API, navigate to canvas |
| `Given I am on the canvas for model {string}` | Navigate to `/models/{id}` |
| `Given I am in browse mode for model {string}` | Navigate to `/models/{id}/browse` |
| `Given there are two connected nodes on the canvas` | Seed model with nodes and an edge |
| `Given a sequence model exists` | Seed model with `model_type: 'sequence'` |

### When Steps

| Pattern | Purpose |
|---------|---------|
| `When I add a {string} entity named {string}` | Open EntityDialog, select type, enter name, confirm |
| `When I connect {string} to {string}` | Drag from source handle to target handle |
| `When I select relationship type {string}` | Choose type in RelationshipDialog |
| `When I press {string}` | Simulate keyboard input |
| `When I click on node {string}` | Click a canvas node by label |
| `When I save the canvas` | Trigger Ctrl+S |
| `When I reload the page` | `page.reload()` |

### Then Steps

| Pattern | Purpose |
|---------|---------|
| `Then a {string} node appears on the canvas` | Assert node exists with correct type |
| `Then an edge connects {string} to {string}` | Assert edge between two nodes |
| `Then the RelationshipDialog is open` | Assert dialog visibility |
| `Then EntityDetailPanel shows {string}` | Assert panel content |
| `Then the canvas has {int} nodes` | Assert node count |
| `Then the node type is {string} not {string}` | Assert correct node type registration |

---

## Dual-Project Playwright Configuration

The Playwright config defines two separate projects:

```typescript
// playwright.config.ts
import { defineConfig } from '@playwright/test';

export default defineConfig({
    projects: [
        {
            name: 'e2e',
            testDir: './e2e',
            testMatch: '**/*.spec.ts',
        },
        {
            name: 'bdd',
            testDir: './.features-gen',    // generated by bddgen
            testMatch: '**/*.spec.js',
        },
    ],
});
```

### Running Tests

| Command | Scope |
|---------|-------|
| `npx playwright test --project=e2e` | Existing 41 E2E tests only |
| `npx playwright test --project=bdd` | BDD canvas tests only |
| `npx playwright test` | All tests (both projects) |

---

## CI Integration with bddgen

The CI pipeline runs `bddgen` before test execution to generate Playwright test files from Gherkin features:

```
1. npm ci
2. npx bddgen                         # generate .features-gen/ from .feature files
3. npx playwright test --project=bdd   # run generated BDD tests
4. npx playwright test --project=e2e   # run existing E2E tests
```

The `.features-gen/` directory is gitignored. It is regenerated on every CI run.

---

## Test Data Seeding Strategy

BDD tests reuse the existing `fixtures.ts` helpers from the e2e project for test data setup:

| Helper | Purpose |
|--------|---------|
| `createTestUser()` | Create and authenticate a test user |
| `createModel(type, name)` | Create a model via API with the given type and name |
| `createEntity(modelId, type, name)` | Create an entity via API and add to model |
| `seedCanvasData(modelId, nodes, edges)` | PUT model data with pre-built nodes and edges |

### Seeding Approach

- **API-first seeding:** All test data is created via API calls in `Given` steps, not through UI interaction
- **Isolation:** Each scenario creates its own model and entities to avoid cross-test interference
- **Cleanup:** Test data is cleaned up after each scenario via API delete calls (or database reset)

### Fixture Extension for BDD

```typescript
import { test as base } from 'playwright-bdd';
import { createTestUser, createModel } from '../e2e/fixtures';

export const test = base.extend<{
    authenticatedPage: Page;
    testModel: Model;
}>({
    authenticatedPage: async ({ page }, use) => {
        await createTestUser(page);
        await use(page);
    },
    testModel: async ({ authenticatedPage }, use) => {
        const model = await createModel(authenticatedPage, 'simple', 'Test Model');
        await use(model);
    },
});
```

---

## File Structure

```
tests/
├── e2e/                          # Existing 41 E2E tests (unchanged)
│   ├── fixtures.ts
│   └── *.spec.ts
├── bdd/
│   ├── features/                 # Gherkin feature files
│   │   ├── canvas-entity-add.feature
│   │   ├── canvas-entity-delete.feature
│   │   ├── canvas-relationship-create.feature
│   │   └── ... (12 files total)
│   ├── steps/                    # Step definitions
│   │   ├── canvas.steps.ts
│   │   ├── entity.steps.ts
│   │   └── relationship.steps.ts
│   └── fixtures.ts               # BDD fixture extensions
├── .features-gen/                 # Generated by bddgen (gitignored)
└── playwright.config.ts           # Dual-project config
```

---

## Acceptance Criteria

| Criterion | Verification |
|-----------|-------------|
| All 12 feature files parse without errors | `npx bddgen` succeeds |
| BDD tests run independently of e2e tests | `--project=bdd` runs only BDD tests |
| Existing 41 e2e tests are unaffected | `--project=e2e` passes with no changes |
| Test data seeding uses API, not UI | Given steps call API helpers, not UI interactions |
| CI pipeline generates and runs BDD tests | CI log shows bddgen + playwright test sequence |

---

*This specification implements [ADR-011](../ADR-011-Canvas-Integration-Testing.md).*
